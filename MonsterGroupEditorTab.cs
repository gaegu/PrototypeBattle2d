using UnityEngine;
using UnityEditor;
using System.Collections.Generic;
using System.Linq;
using BattleCharacterSystem;

public class MonsterGroupEditorTab
{
    // Îç∞Ïù¥ÌÑ∞ Î¶¨Ïä§Ìä∏
    private List<MonsterGroupDataSO> groupDataList = new List<MonsterGroupDataSO>();
    private MonsterGroupDataSO selectedGroup;

    // Î™¨Ïä§ÌÑ∞ ÏÑ†ÌÉùÏö©
    private List<BattleMonsterDataSO> availableMonsters = new List<BattleMonsterDataSO>();

    // Í≤ÄÏÉâ/ÌïÑÌÑ∞
    private string searchString = "";
    private string filterPurpose = "All";
    private bool showFilters = false;

    // UI ÏÉÅÌÉú
    private Vector2 listScrollPos;
    private Vector2 detailScrollPos;
    private Vector2 monsterPickerScrollPos;
    private bool isDirty = false;
    private bool showMonsterPicker = false;
    private int monsterPickerSlot = -1;

    // Ïä¨Î°Ø ÏãúÍ∞ÅÌôî
    private bool showFormationPreview = true;

    // Ïä§ÌÉÄÏùº
    private GUIStyle headerStyle;
    private GUIStyle slotStyle;
    private GUIStyle emptySlotStyle;
    private GUIStyle filledSlotStyle;

    // UI ÏÉÅÌÉú ÏïÑÎûòÏóê Ï∂îÍ∞Ä
    private string monsterSearchString = "";  // Î™¨Ïä§ÌÑ∞ Í≤ÄÏÉâ
    private BattleCharacterSystem.MonsterType filterMonsterType = BattleCharacterSystem.MonsterType.Normal;  // Î™¨Ïä§ÌÑ∞ ÌÉÄÏûÖ ÌïÑÌÑ∞
    private bool showAllTypes = true;  // Î™®Îì† ÌÉÄÏûÖ ÌëúÏãú Ïó¨Î∂Ä
                                       // ID Í¥ÄÎ¶¨Î•º ÏúÑÌïú Ï∂îÍ∞Ä ÌïÑÎìú

    private static int lastAssignedId = 4999;  // ÎßàÏßÄÎßâ Ìï†ÎãπÎêú ID Ï†ÄÏû•

    public void Initialize()
    {
        LoadAllGroupData();

        if (groupDataList != null && groupDataList.Count > 0)
        {
            lastAssignedId = groupDataList.Max(g => g.GroupId);
        }

        LoadAvailableMonsters();
        InitializeStyles();
    }

    private void InitializeStyles()
    {
        headerStyle = new GUIStyle();
        headerStyle.fontSize = 14;
        headerStyle.fontStyle = FontStyle.Bold;
        headerStyle.normal.textColor = Color.white;
        headerStyle.padding = new RectOffset(5, 5, 5, 5);

        slotStyle = new GUIStyle();
        slotStyle.alignment = TextAnchor.MiddleCenter;
        slotStyle.normal.background = MakeTexture(2, 2, new Color(0.3f, 0.3f, 0.3f, 0.5f));
        slotStyle.normal.textColor = Color.white;

        emptySlotStyle = new GUIStyle(slotStyle);
        emptySlotStyle.normal.background = MakeTexture(2, 2, new Color(0.2f, 0.2f, 0.2f, 0.3f));

        filledSlotStyle = new GUIStyle(slotStyle);
        filledSlotStyle.normal.background = MakeTexture(2, 2, new Color(0.3f, 0.5f, 0.3f, 0.5f));
    }

    private Texture2D MakeTexture(int width, int height, Color color)
    {
        Color[] pixels = new Color[width * height];
        for (int i = 0; i < pixels.Length; i++)
            pixels[i] = color;

        Texture2D result = new Texture2D(width, height);
        result.SetPixels(pixels);
        result.Apply();
        return result;
    }

    public void DrawMonsterGroupTab()
    {
        using (new EditorGUILayout.HorizontalScope())
        {
            // ÏôºÏ™Ω Ìå®ÎÑê (Î¶¨Ïä§Ìä∏)
            using (new EditorGUILayout.VerticalScope(GUILayout.Width(300)))
            {
                DrawSearchBar();
                DrawGroupList();
            }

            // Íµ¨Î∂ÑÏÑ†
            GUILayout.Box("", GUILayout.Width(2), GUILayout.ExpandHeight(true));

            // Ïò§Î•∏Ï™Ω Ìå®ÎÑê (ÎîîÌÖåÏùº)
            using (new EditorGUILayout.VerticalScope())
            {
                DrawGroupDetails();
            }
        }

        // Î™¨Ïä§ÌÑ∞ ÏÑ†ÌÉù ÌåùÏóÖ
        if (showMonsterPicker)
        {
            DrawMonsterPicker();
        }
    }

    private void DrawSearchBar()
    {
        using (new EditorGUILayout.HorizontalScope())
        {
            searchString = EditorGUILayout.TextField(searchString, EditorStyles.toolbarSearchField);

            if (GUILayout.Button("Clear", EditorStyles.toolbarButton, GUILayout.Width(50)))
            {
                searchString = "";
                GUI.FocusControl(null);
            }
        }

        showFilters = EditorGUILayout.Foldout(showFilters, "Filters");
        if (showFilters)
        {
            using (new EditorGUILayout.VerticalScope(EditorStyles.helpBox))
            {
                string[] purposes = new string[] { "All", "Tutorial", "Normal", "Boss", "Special", "Event" };
                int selectedIndex = System.Array.IndexOf(purposes, filterPurpose);
                selectedIndex = EditorGUILayout.Popup("Purpose", selectedIndex, purposes);
                filterPurpose = purposes[selectedIndex];
            }
        }

        EditorGUILayout.Space(5);
    }

    private void DrawGroupList()
    {
        // ÏÉàÎ°ú ÎßåÎì§Í∏∞ Î≤ÑÌäº
        if (GUILayout.Button("+ Create New Group", GUILayout.Height(30)))
        {
            CreateNewGroup();
        }

        // ÌÖúÌîåÎ¶øÏóêÏÑú ÏÉùÏÑ±
        using (new EditorGUILayout.HorizontalScope())
        {
            if (GUILayout.Button("Tutorial", GUILayout.Height(25)))
                CreateFromTemplate("Tutorial");
            if (GUILayout.Button("Balanced", GUILayout.Height(25)))
                CreateFromTemplate("Balanced");
            if (GUILayout.Button("Boss", GUILayout.Height(25)))
                CreateFromTemplate("Boss");
        }

        EditorGUILayout.Space(5);

        // Í∑∏Î£π Î¶¨Ïä§Ìä∏
        using (var scrollView = new EditorGUILayout.ScrollViewScope(listScrollPos))
        {
            listScrollPos = scrollView.scrollPosition;

            var filteredList = GetFilteredGroupList();

            // PurposeÎ≥ÑÎ°ú Í∑∏Î£πÌôî
            var groupedByPurpose = filteredList.GroupBy(g => g.GroupPurpose).OrderBy(g => g.Key);

            foreach (var purposeGroup in groupedByPurpose)
            {
                EditorGUILayout.LabelField($"üìÅ {purposeGroup.Key}", EditorStyles.boldLabel);

                foreach (var group in purposeGroup.OrderBy(g => g.GroupId))
                {
                    if (group == null) continue;

                    bool isSelected = (group == selectedGroup);

                    using (new EditorGUILayout.HorizontalScope(isSelected ? EditorStyles.helpBox : GUIStyle.none))
                    {
                        // Í∑∏Î£π Ï†ïÎ≥¥
                        using (new EditorGUILayout.VerticalScope())
                        {
                            string displayName = $"[{group.GroupId}] {group.GroupName}";
                            if (GUILayout.Button(displayName, EditorStyles.label))
                            {
                                SelectGroup(group);
                            }

                            // Ï∂îÍ∞Ä Ï†ïÎ≥¥
                            string info = $"Lv.{group.RecommendedLevel} | ÎÇúÏù¥ÎèÑ:{group.Difficulty} | Î™¨Ïä§ÌÑ∞:{group.GetActiveMonsterCount()}/5";
                            GUILayout.Label(info, EditorStyles.miniLabel);

                            // Ï†ÑÌà¨Î†• ÌëúÏãú
                            GUILayout.Label($"‚ö° Power: {group.TotalPower}", EditorStyles.miniLabel);
                        }

                        GUILayout.FlexibleSpace();

                        // Î≥µÏÇ¨ Î≤ÑÌäº
                        if (GUILayout.Button("üìã", GUILayout.Width(25)))
                        {
                            DuplicateGroup(group);
                        }

                        // ÏÇ≠Ï†ú Î≤ÑÌäº
                        GUI.backgroundColor = Color.red;
                        if (GUILayout.Button("X", GUILayout.Width(25)))
                        {
                            DeleteGroup(group);
                        }
                        GUI.backgroundColor = Color.white;
                    }
                }

                EditorGUILayout.Space(3);
            }
        }
    }

    private void DrawGroupDetails()
    {
        if (selectedGroup == null)
        {
            EditorGUILayout.HelpBox("Select a group from the list or create a new one.", MessageType.Info);
            return;
        }

        using (var scrollView = new EditorGUILayout.ScrollViewScope(detailScrollPos))
        {
            detailScrollPos = scrollView.scrollPosition;

            EditorGUI.BeginChangeCheck();

            // Í∏∞Î≥∏ Ï†ïÎ≥¥
            DrawBasicInfo();
            EditorGUILayout.Space(10);

            // Î™¨Ïä§ÌÑ∞ Ïä¨Î°Ø
            DrawMonsterSlots();
            EditorGUILayout.Space(10);

            // ÏßÑÌòï ÏÑ§Ï†ï
            DrawFormationSettings();
            EditorGUILayout.Space(10);

            // Ï†ÑÌà¨ ÏÑ§Ï†ï
            DrawBattleSettings();
            EditorGUILayout.Space(10);

            // Î≥¥ÏÉÅ ÏÑ§Ï†ï
            DrawRewardSettings();

            if (EditorGUI.EndChangeCheck())
            {
                isDirty = true;
            }

            // Ï†ÄÏû• Î≤ÑÌäº
            EditorGUILayout.Space(20);
            DrawSaveButton();
        }
    }

    private void DrawBasicInfo()
    {
        EditorGUILayout.LabelField("Basic Info", headerStyle);
        using (new EditorGUILayout.VerticalScope(EditorStyles.helpBox))
        {
            var serializedObject = new SerializedObject(selectedGroup);

            // IDÎäî ÏùΩÍ∏∞ Ï†ÑÏö©ÏúºÎ°ú ÌëúÏãú
            GUI.enabled = false;
            EditorGUILayout.PropertyField(serializedObject.FindProperty("groupId"));
            GUI.enabled = true;

            // Ïù¥Î¶Ñ Î≥ÄÍ≤Ω Í∞êÏßÄ
            var nameProp = serializedObject.FindProperty("groupName");
            string oldName = nameProp.stringValue;
            EditorGUILayout.PropertyField(nameProp);

            EditorGUILayout.PropertyField(serializedObject.FindProperty("description"));

            EditorGUILayout.Space(5);

            EditorGUILayout.PropertyField(serializedObject.FindProperty("groupPurpose"));
            EditorGUILayout.PropertyField(serializedObject.FindProperty("recommendedLevel"));
            EditorGUILayout.PropertyField(serializedObject.FindProperty("difficulty"));

            serializedObject.ApplyModifiedProperties();

            // Ïù¥Î¶ÑÏù¥ Î≥ÄÍ≤ΩÎêòÏóàÏúºÎ©¥ ÌååÏùºÎ™ÖÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
            if (oldName != nameProp.stringValue)
            {
                isDirty = true;
            }
        }
    }

    private void DrawMonsterSlots()
    {
        EditorGUILayout.LabelField("Monster Slots", headerStyle);

        // ÏßÑÌòï ÎØ∏Î¶¨Î≥¥Í∏∞
        if (showFormationPreview)
        {
            DrawFormationPreview();
        }

        EditorGUILayout.Space(5);

        // Ïä¨Î°ØÎ≥Ñ ÏÉÅÏÑ∏ Ï†ïÎ≥¥
        using (new EditorGUILayout.VerticalScope(EditorStyles.helpBox))
        {
            for (int i = 0; i < 5; i++)
            {
                DrawMonsterSlot(i);
                if (i < 4) EditorGUILayout.Space(3);
            }
        }

        // Ï†ÑÏ≤¥ ÌÅ¥Î¶¨Ïñ¥ Î≤ÑÌäº
        EditorGUILayout.Space(5);
        if (GUILayout.Button("Clear All Slots", GUILayout.Height(25)))
        {
            if (EditorUtility.DisplayDialog("Clear All", "Remove all monsters from group?", "Clear", "Cancel"))
            {
                selectedGroup.ClearAllMonsters();
                EditorUtility.SetDirty(selectedGroup);
            }
        }
    }

    private void DrawFormationPreview()
    {
        EditorGUILayout.LabelField("Formation Preview:", EditorStyles.miniBoldLabel);

        using (new EditorGUILayout.HorizontalScope())
        {
            GUILayout.FlexibleSpace();

            // ÏßÑÌòïÏóê Îî∞Î•∏ Ïä¨Î°Ø Î∞∞Ïπò ÏãúÍ∞ÅÌôî
            switch (selectedGroup.FormationType)
            {
                case FormationType.Offensive: // 1-4
                    DrawSlotBox(0);
                    GUILayout.Space(20);
                    using (new EditorGUILayout.VerticalScope())
                    {
                        DrawSlotBox(1);
                        DrawSlotBox(2);
                        DrawSlotBox(3);
                        DrawSlotBox(4);
                    }
                    break;

                case FormationType.Defensive: // 4-1
                    using (new EditorGUILayout.VerticalScope())
                    {
                        DrawSlotBox(0);
                        DrawSlotBox(1);
                        DrawSlotBox(2);
                        DrawSlotBox(3);
                    }
                    GUILayout.Space(20);
                    DrawSlotBox(4);
                    break;

                case FormationType.OffensiveBalance: // 2-3
                    using (new EditorGUILayout.VerticalScope())
                    {
                        DrawSlotBox(0);
                        DrawSlotBox(1);
                    }
                    GUILayout.Space(20);
                    using (new EditorGUILayout.VerticalScope())
                    {
                        DrawSlotBox(2);
                        DrawSlotBox(3);
                        DrawSlotBox(4);
                    }
                    break;

                case FormationType.DefensiveBalance: // 3-2
                    using (new EditorGUILayout.VerticalScope())
                    {
                        DrawSlotBox(0);
                        DrawSlotBox(1);
                        DrawSlotBox(2);
                    }
                    GUILayout.Space(20);
                    using (new EditorGUILayout.VerticalScope())
                    {
                        DrawSlotBox(3);
                        DrawSlotBox(4);
                    }
                    break;
            }

            GUILayout.FlexibleSpace();
        }
    }

    private void DrawSlotBox(int index)
    {
        var slot = selectedGroup.MonsterSlots[index];
        string label = slot.isEmpty ? $"Slot {index}" : GetMonsterShortName(slot.monsterData);

        var style = slot.isEmpty ? emptySlotStyle : filledSlotStyle;

        if (GUILayout.Button(label, style, GUILayout.Width(80), GUILayout.Height(40)))
        {
            ShowMonsterPicker(index);
        }
    }

    private string GetMonsterShortName(BattleMonsterDataSO monster)
    {
        if (monster == null) return "Empty";

        string name = monster.MonsterName;
        if (name.Length > 8)
        {
            name = name.Substring(0, 8) + "..";
        }

        string icon = GetMonsterIcon(monster.MonsterType);
        return $"{icon}{name}";
    }

    private void DrawMonsterSlot(int index)
    {
        var slot = selectedGroup.MonsterSlots[index];

        using (new EditorGUILayout.HorizontalScope())
        {
            EditorGUILayout.LabelField($"Slot {index}:", GUILayout.Width(60));

            if (slot.isEmpty)
            {
                EditorGUILayout.LabelField("[Empty]", EditorStyles.miniLabel);
            }
            else if (slot.monsterData != null)
            {
                EditorGUILayout.LabelField($"{GetMonsterIcon(slot.monsterData.MonsterType)} {slot.monsterData.MonsterName}",
                    GUILayout.Width(150));

                // Î†àÎ≤® ÏÑ§Ï†ï
                EditorGUILayout.LabelField("Lv:", GUILayout.Width(25));
                int newLevel = EditorGUILayout.IntField(slot.level, GUILayout.Width(50));
                if (newLevel != slot.level)
                {
                    slot.level = Mathf.Clamp(newLevel, 1, 200);
                    selectedGroup.CalculateTotalPower();
                    EditorUtility.SetDirty(selectedGroup);
                    isDirty = true;
                }
            }

            GUILayout.FlexibleSpace();

            // Î™¨Ïä§ÌÑ∞ ÏÑ†ÌÉù Î≤ÑÌäº
            GUI.backgroundColor = slot.isEmpty ? Color.green : Color.cyan;
            if (GUILayout.Button(slot.isEmpty ? "Select" : "Change", GUILayout.Width(60)))
            {
                ShowMonsterSelectionWindow(index);
            }
            GUI.backgroundColor = Color.white;

            // Ï†úÍ±∞ Î≤ÑÌäº
            if (!slot.isEmpty)
            {
                GUI.backgroundColor = Color.red;
                if (GUILayout.Button("X", GUILayout.Width(25)))
                {
                    selectedGroup.RemoveMonster(index);
                    EditorUtility.SetDirty(selectedGroup);
                    isDirty = true;
                }
                GUI.backgroundColor = Color.white;
            }
        }
    }

    private void ShowMonsterSelectionWindow(int slotIndex)
    {
        MonsterSelectionWindow.ShowWindow(slotIndex, (monsterId, slotIdx) =>
        {
            var monster = availableMonsters.FirstOrDefault(m => m.MonsterId == monsterId);
            if (monster != null)
            {
                selectedGroup.AddMonster(slotIdx, monster, selectedGroup.RecommendedLevel);
                EditorUtility.SetDirty(selectedGroup);
                isDirty = true;
            }
        });
    }

    private void DrawFormationSettings()
    {
        EditorGUILayout.LabelField("Formation Settings", headerStyle);
        using (new EditorGUILayout.VerticalScope(EditorStyles.helpBox))
        {
            var serializedObject = new SerializedObject(selectedGroup);

            EditorGUILayout.PropertyField(serializedObject.FindProperty("formationType"));
            EditorGUILayout.PropertyField(serializedObject.FindProperty("useCustomFormation"));

            serializedObject.ApplyModifiedProperties();

            // ÏßÑÌòï ÎØ∏Î¶¨Î≥¥Í∏∞ ÌÜ†Í∏Ä
            showFormationPreview = EditorGUILayout.Toggle("Show Formation Preview", showFormationPreview);
        }
    }

    private void DrawBattleSettings()
    {
        EditorGUILayout.LabelField("Battle Settings", headerStyle);
        using (new EditorGUILayout.VerticalScope(EditorStyles.helpBox))
        {
            var serializedObject = new SerializedObject(selectedGroup);

            // Ï†ÑÌà¨Î†•
            EditorGUILayout.LabelField($"Total Power: {selectedGroup.TotalPower}", EditorStyles.boldLabel);

            var autoCalcProp = serializedObject.FindProperty("autoCalculatePower");
            EditorGUILayout.PropertyField(autoCalcProp);

            if (!autoCalcProp.boolValue)
            {
                EditorGUILayout.PropertyField(serializedObject.FindProperty("totalPower"));
            }
            else
            {
                if (GUILayout.Button("Recalculate Power"))
                {
                    selectedGroup.CalculateTotalPower();
                }
            }

            EditorGUILayout.Space(5);

            // ÌäπÏàò Ï°∞Í±¥
            EditorGUILayout.PropertyField(serializedObject.FindProperty("hasTimeLimit"));
            if (serializedObject.FindProperty("hasTimeLimit").boolValue)
            {
                EditorGUILayout.PropertyField(serializedObject.FindProperty("timeLimit"));
            }

            EditorGUILayout.PropertyField(serializedObject.FindProperty("hasSpecialCondition"));
            if (serializedObject.FindProperty("hasSpecialCondition").boolValue)
            {
                EditorGUILayout.PropertyField(serializedObject.FindProperty("specialConditionDescription"));
            }

            serializedObject.ApplyModifiedProperties();
        }
    }

    private void DrawRewardSettings()
    {
        EditorGUILayout.LabelField("Reward Settings", headerStyle);
        using (new EditorGUILayout.VerticalScope(EditorStyles.helpBox))
        {
            var serializedObject = new SerializedObject(selectedGroup);

            EditorGUILayout.PropertyField(serializedObject.FindProperty("goldReward"));
            EditorGUILayout.PropertyField(serializedObject.FindProperty("expReward"));
            EditorGUILayout.PropertyField(serializedObject.FindProperty("itemRewardIds"), true);

            serializedObject.ApplyModifiedProperties();
        }
    }

    private void DrawSaveButton()
    {
        using (new EditorGUILayout.HorizontalScope())
        {
            GUILayout.FlexibleSpace();

            // Í≤ÄÏ¶ù Î≤ÑÌäº
            if (GUILayout.Button("Validate", GUILayout.Width(100), GUILayout.Height(30)))
            {
                string error;
                if (selectedGroup.ValidateGroup(out error))
                {
                    EditorUtility.DisplayDialog("Validation", "Group is valid!", "OK");
                }
                else
                {
                    EditorUtility.DisplayDialog("Validation Failed", error, "OK");
                }
            }

            // Ï†ÄÏû• Î≤ÑÌäº
            if (isDirty)
            {
                GUI.backgroundColor = new Color(1f, 0.8f, 0.2f);
                if (GUILayout.Button("üíæ Save Changes", GUILayout.Height(30), GUILayout.Width(150)))
                {
                    SaveChanges();
                }
                GUI.backgroundColor = Color.white;
            }
            else
            {
                GUI.enabled = false;
                GUILayout.Button("‚úì Saved", GUILayout.Height(30), GUILayout.Width(150));
                GUI.enabled = true;
            }

            GUILayout.FlexibleSpace();
        }
    }

    // Î™¨Ïä§ÌÑ∞ ÏÑ†ÌÉù ÌåùÏóÖ
    private void ShowMonsterPicker(int slotIndex)
    {
        monsterPickerSlot = slotIndex;
        showMonsterPicker = true;
    }

    private void DrawMonsterPicker()
    {
        // ÌåùÏóÖ Ï∞Ω Ïä§ÌÉÄÏùº
        Rect windowRect = new Rect(
            (Screen.width - 400) / 2,
            (Screen.height - 500) / 2,
            400, 500
        );

        GUI.Window(999, windowRect, DrawMonsterPickerWindow, "Select Monster");
    }

    private void DrawMonsterPickerWindow(int windowId)
    {
        // Îã´Í∏∞ Î≤ÑÌäº
        if (GUI.Button(new Rect(370, 5, 25, 20), "X"))
        {
            showMonsterPicker = false;
            monsterPickerSlot = -1;
        }

        GUILayout.Space(25);

        // Î™¨Ïä§ÌÑ∞ Î¶¨Ïä§Ìä∏
        using (var scrollView = new EditorGUILayout.ScrollViewScope(monsterPickerScrollPos))
        {
            monsterPickerScrollPos = scrollView.scrollPosition;

            // None ÏòµÏÖò
            if (GUILayout.Button("[None - Clear Slot]"))
            {
                selectedGroup.RemoveMonster(monsterPickerSlot);
                showMonsterPicker = false;
                EditorUtility.SetDirty(selectedGroup);
            }

            EditorGUILayout.Space(5);

            // ÌÉÄÏûÖÎ≥ÑÎ°ú Í∑∏Î£πÌôî
            var groupedMonsters = availableMonsters.GroupBy(m => m.MonsterType).OrderBy(g => g.Key);

            foreach (var group in groupedMonsters)
            {
                EditorGUILayout.LabelField($"{GetMonsterIcon(group.Key)} {group.Key}", EditorStyles.boldLabel);

                foreach (var monster in group.OrderBy(m => m.MonsterId))
                {
                    if (GUILayout.Button($"[{monster.MonsterId}] {monster.MonsterName}"))
                    {
                        selectedGroup.AddMonster(monsterPickerSlot, monster, selectedGroup.RecommendedLevel);
                        showMonsterPicker = false;
                        EditorUtility.SetDirty(selectedGroup);
                    }
                }

                EditorGUILayout.Space(3);
            }
        }
    }

    // Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨ Î©îÏÑúÎìú
    private void LoadAllGroupData()
    {
        groupDataList.Clear();

        string[] guids = AssetDatabase.FindAssets("t:MonsterGroupDataSO");
        foreach (string guid in guids)
        {
            string path = AssetDatabase.GUIDToAssetPath(guid);
            MonsterGroupDataSO data = AssetDatabase.LoadAssetAtPath<MonsterGroupDataSO>(path);
            if (data != null)
            {
                groupDataList.Add(data);
                Debug.Log($"Loaded: {data.name} (ID: {data.GroupId})"); // ÎîîÎ≤ÑÍ∑∏ Ï∂îÍ∞Ä
            }
        }

        groupDataList = groupDataList.OrderBy(g => g.GroupId).ToList();
    }

    private void LoadAvailableMonsters()
    {
        availableMonsters.Clear();

        string[] guids = AssetDatabase.FindAssets("t:BattleMonsterDataSO");
        foreach (string guid in guids)
        {
            string path = AssetDatabase.GUIDToAssetPath(guid);
            BattleMonsterDataSO data = AssetDatabase.LoadAssetAtPath<BattleMonsterDataSO>(path);
            if (data != null)
            {
                availableMonsters.Add(data);
            }
        }

        availableMonsters = availableMonsters.OrderBy(m => m.MonsterId).ToList();
    }

    private List<MonsterGroupDataSO> GetFilteredGroupList()
    {
        var filtered = groupDataList.AsEnumerable();

        if (!string.IsNullOrEmpty(searchString))
        {
            filtered = filtered.Where(g =>
                g.GroupName.ToLower().Contains(searchString.ToLower()) ||
                g.GroupId.ToString().Contains(searchString));
        }

        if (showFilters && filterPurpose != "All")
        {
            filtered = filtered.Where(g => g.GroupPurpose == filterPurpose);
        }

        return filtered.ToList();
    }

    private void SelectGroup(MonsterGroupDataSO group)
    {
        selectedGroup = group;
    }


    // ID ÏûêÎèô ÏÉùÏÑ± Í∞úÏÑ†
    private int GetNextGroupId()
    {
        // 1. Í∏∞Ï°¥ Í∑∏Î£πÎì§ÏóêÏÑú ÏµúÎåÄ ID Ï∞æÍ∏∞
        int maxId = 4999;

        // ÌòÑÏû¨ Î°úÎìúÎêú Í∑∏Î£πÏóêÏÑú ÏµúÎåÄÍ∞í Ï∞æÍ∏∞
        if (groupDataList != null && groupDataList.Count > 0)
        {
            maxId = groupDataList.Max(g => g.GroupId);
        }

        // 2. Ï†ÄÏû•Îêú Î™®Îì† MonsterGroup ÌååÏùº Í≤ÄÏÇ¨ (ÌòπÏãú Î°úÎìú Ïïà Îêú Í≤É Ï≤¥ÌÅ¨)
        string[] guids = AssetDatabase.FindAssets("t:MonsterGroupDataSO");
        foreach (string guid in guids)
        {
            string path = AssetDatabase.GUIDToAssetPath(guid);
            MonsterGroupDataSO data = AssetDatabase.LoadAssetAtPath<MonsterGroupDataSO>(path);
            if (data != null && data.GroupId > maxId)
            {
                maxId = data.GroupId;
            }
        }

        // 3. lastAssignedIdÏôÄ ÎπÑÍµêÌïòÏó¨ Îçî ÌÅ∞ Í∞í ÏÇ¨Ïö©
        if (lastAssignedId > maxId)
        {
            maxId = lastAssignedId;
        }

        // 4. Îã§Ïùå ID Ìï†Îãπ
        int nextId = maxId + 1;
        lastAssignedId = nextId;

        Debug.Log($"[MonsterGroupTab] Generated new ID: {nextId}");
        return nextId;
    }

    // ÏÉà Í∑∏Î£π ÏÉùÏÑ± ÏàòÏ†ï
    private void CreateNewGroup()
    {
        var newGroup = ScriptableObject.CreateInstance<MonsterGroupDataSO>();

        // ÏûêÎèô ID Ìï†Îãπ
        int nextId = GetNextGroupId();

        // Í∏∞Î≥∏ Ïù¥Î¶Ñ ÏÑ§Ï†ï
        string defaultName = $"MonsterGroup_{nextId}";

        // Î¶¨ÌîåÎ†âÏÖòÏúºÎ°ú private ÌïÑÎìú ÏÑ§Ï†ï
        var type = newGroup.GetType();
        var bindingFlags = System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance;

        type.GetField("groupId", bindingFlags)?.SetValue(newGroup, nextId);
        type.GetField("groupName", bindingFlags)?.SetValue(newGroup, defaultName);

        // ÌååÏùºÎ™Ö: GroupName_ID ÌòïÏãù
        newGroup.name = $"{defaultName}_{nextId}";

        // Ï†ÄÏû•
        SaveGroupAsset(newGroup);

        LoadAllGroupData();
        SelectGroup(newGroup);
    }

    // ÌÖúÌîåÎ¶øÏóêÏÑú ÏÉùÏÑ± ÏàòÏ†ï
    private void CreateFromTemplate(string templateType)
    {
        var newGroup = ScriptableObject.CreateInstance<MonsterGroupDataSO>();
        newGroup.InitializeFromTemplate(templateType);

        // ÏûêÎèô ID Ìï†Îãπ
        int nextId = GetNextGroupId();

        // ÌÖúÌîåÎ¶ø Í∏∞Î∞ò Ïù¥Î¶Ñ
        string groupName = $"{templateType}Group_{nextId}";

        // Î¶¨ÌîåÎ†âÏÖòÏúºÎ°ú ÏÑ§Ï†ï
        var type = newGroup.GetType();
        var bindingFlags = System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance;

        type.GetField("groupId", bindingFlags)?.SetValue(newGroup, nextId);
        type.GetField("groupName", bindingFlags)?.SetValue(newGroup, groupName);

        // ÌååÏùºÎ™Ö: GroupName_ID ÌòïÏãù
        newGroup.name = $"{groupName}_{nextId}";

        // Ï†ÄÏû•
        SaveGroupAsset(newGroup);

        LoadAllGroupData();
        SelectGroup(newGroup);
    }

    private void DuplicateGroup(MonsterGroupDataSO original)
    {
        if (original == null) return;

        var copy = Object.Instantiate(original);

        // ÏÉà ID Ìï†Îãπ
        int nextId = GetNextGroupId();

        // Ïù¥Î¶Ñ ÏÑ§Ï†ï (ÏõêÎ≥∏ Ïù¥Î¶ÑÏóê _Copy Ï∂îÍ∞Ä)
        string baseName = original.GroupName;
        if (baseName.Contains("_Copy"))
        {
            // Ïù¥ÎØ∏ CopyÍ∞Ä ÏûàÏúºÎ©¥ Ïà´Ïûê Ï¶ùÍ∞Ä
            baseName = baseName.Substring(0, baseName.IndexOf("_Copy"));
        }
        string copyName = $"{baseName}_Copy";

        // Î¶¨ÌîåÎ†âÏÖòÏúºÎ°ú ÏÑ§Ï†ï
        var type = copy.GetType();
        var bindingFlags = System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance;

        type.GetField("groupId", bindingFlags)?.SetValue(copy, nextId);
        type.GetField("groupName", bindingFlags)?.SetValue(copy, copyName);

        // ÌååÏùºÎ™Ö: GroupName_ID ÌòïÏãù
        copy.name = $"{copyName}_{nextId}";

        // Ï†ÄÏû•
        SaveGroupAsset(copy);

        LoadAllGroupData();
        SelectGroup(copy);
    }
    // Ï†ÄÏû• Î©îÏÑúÎìú ÌÜµÌï©
    private void SaveGroupAsset(MonsterGroupDataSO group)
    {
        string directory = "Assets/Cosmos/ResourcesAddressable/ScriptableObjects/MonsterGroups";

        // ÎîîÎ†âÌÜ†Î¶¨ ÌôïÏù∏/ÏÉùÏÑ±
        if (!AssetDatabase.IsValidFolder(directory))
        {
            System.IO.Directory.CreateDirectory(directory);
            AssetDatabase.Refresh();
        }

        // ÌååÏùºÎ™Ö Ï†ïÎ¶¨ (ÌäπÏàòÎ¨∏Ïûê Ï†úÍ±∞)
        string safeName = SanitizeFileName(group.name);
        string path = $"{directory}/{safeName}.asset";

        // Ï§ëÎ≥µ ÌååÏùºÎ™Ö Ï≤¥ÌÅ¨
        int counter = 1;
        string originalPath = path;
        while (AssetDatabase.LoadAssetAtPath<MonsterGroupDataSO>(path) != null)
        {
            path = originalPath.Replace(".asset", $"_{counter}.asset");
            counter++;
        }

        AssetDatabase.CreateAsset(group, path);
        AssetDatabase.SaveAssets();

        Debug.Log($"[MonsterGroupTab] Saved: {path}");
    }

    // ÌååÏùºÎ™Ö Ï†ïÎ¶¨ Î©îÏÑúÎìú
    private string SanitizeFileName(string fileName)
    {
        // ÌååÏùºÎ™ÖÏóê ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÎäî Î¨∏Ïûê Ï†úÍ±∞
        char[] invalidChars = System.IO.Path.GetInvalidFileNameChars();
        string safe = fileName;

        foreach (char c in invalidChars)
        {
            safe = safe.Replace(c.ToString(), "");
        }

        // Í≥µÎ∞±ÏùÑ Ïñ∏ÎçîÏä§ÏΩîÏñ¥Î°ú Î≥ÄÍ≤Ω
        safe = safe.Replace(" ", "_");

        return safe;
    }


    // Í∑∏Î£π Ïù¥Î¶Ñ Î≥ÄÍ≤Ω Ïãú ÌååÏùºÎ™ÖÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
    private void UpdateGroupFileName(MonsterGroupDataSO group)
    {
        if (group == null) return;

        string oldPath = AssetDatabase.GetAssetPath(group);
        if (string.IsNullOrEmpty(oldPath)) return;

        // ÏÉà ÌååÏùºÎ™Ö: GroupName_ID ÌòïÏãù
        string newName = $"{group.GroupName}_{group.GroupId}";
        string safeName = SanitizeFileName(newName);

        // Í≤ΩÎ°ú ÏÉùÏÑ±
        string directory = System.IO.Path.GetDirectoryName(oldPath);
        string newPath = $"{directory}/{safeName}.asset";

        // ÌååÏùºÎ™Ö Î≥ÄÍ≤Ω
        if (oldPath != newPath)
        {
            string error = AssetDatabase.RenameAsset(oldPath, safeName);
            if (!string.IsNullOrEmpty(error))
            {
                Debug.LogError($"Failed to rename asset: {error}");
            }
            else
            {
                Debug.Log($"[MonsterGroupTab] Renamed: {oldPath} -> {newPath}");
                AssetDatabase.SaveAssets();
            }
        }
    }


    private void DeleteGroup(MonsterGroupDataSO group)
    {
        if (group == null) return;

        if (EditorUtility.DisplayDialog("Delete Group",
            $"Are you sure you want to delete {group.GroupName}?",
            "Delete", "Cancel"))
        {
            string path = AssetDatabase.GetAssetPath(group);
            AssetDatabase.DeleteAsset(path);
            AssetDatabase.SaveAssets();

            LoadAllGroupData();
            selectedGroup = null;
        }
    }

    private void SaveChanges()
    {
        if (selectedGroup != null)
        {
            // ÌååÏùºÎ™Ö ÏóÖÎç∞Ïù¥Ìä∏ Ï≤¥ÌÅ¨
            UpdateGroupFileName(selectedGroup);

            EditorUtility.SetDirty(selectedGroup);
            AssetDatabase.SaveAssets();
            isDirty = false;

            EditorUtility.DisplayDialog("Saved",
                $"Monster group saved.\nID: {selectedGroup.GroupId}\nName: {selectedGroup.GroupName}",
                "OK");
        }
    }

    private string GetMonsterIcon(BattleCharacterSystem.MonsterType type)
    {
        switch (type)
        {
            case BattleCharacterSystem.MonsterType.Normal: return "üëæ";
            case BattleCharacterSystem.MonsterType.Elite: return "üëπ";
            case BattleCharacterSystem.MonsterType.MiniBoss: return "ü¶æ";
            case BattleCharacterSystem.MonsterType.Boss: return "üë∫";
            case BattleCharacterSystem.MonsterType.Special: return "‚ú®";
            default: return "‚ùì";
        }
    }
}


// Î™¨Ïä§ÌÑ∞ ÏÑ†ÌÉù Ï†ÑÏö© ÌåùÏóÖ ÏúàÎèÑÏö∞
public class MonsterSelectionWindow : EditorWindow
{
    private int targetSlotIndex;
    private System.Action<int, int> onMonsterSelected;

    // Î™¨Ïä§ÌÑ∞ Î¶¨Ïä§Ìä∏
    private List<BattleMonsterDataSO> allMonsters = new List<BattleMonsterDataSO>();
    private Dictionary<BattleCharacterSystem.MonsterType, List<BattleMonsterDataSO>> monstersByType;

    // ÌïÑÌÑ∞/Í≤ÄÏÉâ
    private string searchString = "";
    private BattleCharacterSystem.MonsterType selectedType = BattleCharacterSystem.MonsterType.Normal;
    private bool showAllTypes = true;

    // UI
    private Vector2 scrollPos;
    private GUIStyle headerStyle;
    private bool[] typeFoldouts = new bool[5];  // Í∞Å ÌÉÄÏûÖÎ≥Ñ ÌéºÏπ® ÏÉÅÌÉú

    public static void ShowWindow(int slotIndex, System.Action<int, int> callback)
    {
        var window = GetWindow<MonsterSelectionWindow>(true, "Select Monster");
        window.minSize = new Vector2(500, 600);
        window.maxSize = new Vector2(500, 800);
        window.targetSlotIndex = slotIndex;
        window.onMonsterSelected = callback;
        window.Initialize();
        window.Show();
    }

    private void Initialize()
    {
        LoadMonsters();
        InitializeStyles();

        // Î™®Îì† ÌÉÄÏûÖ ÌéºÏπòÍ∏∞
        for (int i = 0; i < typeFoldouts.Length; i++)
        {
            typeFoldouts[i] = true;
        }
    }

    private void InitializeStyles()
    {
        headerStyle = new GUIStyle();
        headerStyle.fontSize = 13;
        headerStyle.fontStyle = FontStyle.Bold;
        headerStyle.normal.textColor = Color.white;
        headerStyle.padding = new RectOffset(5, 5, 3, 3);
    }

    private void LoadMonsters()
    {
        allMonsters.Clear();

        string[] guids = AssetDatabase.FindAssets("t:BattleMonsterDataSO");
        foreach (string guid in guids)
        {
            string path = AssetDatabase.GUIDToAssetPath(guid);
            var monster = AssetDatabase.LoadAssetAtPath<BattleMonsterDataSO>(path);
            if (monster != null)
            {
                allMonsters.Add(monster);
            }
        }

        // ÌÉÄÏûÖÎ≥ÑÎ°ú Í∑∏Î£πÌôî
        monstersByType = allMonsters
            .GroupBy(m => m.MonsterType)
            .ToDictionary(g => g.Key, g => g.OrderBy(m => m.MonsterId).ToList());
    }

    private void OnGUI()
    {
        EditorGUILayout.Space(5);

        // Ìó§Îçî
        EditorGUILayout.LabelField($"Select Monster for Slot {targetSlotIndex}", headerStyle);
        EditorGUILayout.Space(5);

        // Í≤ÄÏÉâ Î∞î
        DrawSearchBar();

        EditorGUILayout.Space(5);

        // ÌïÑÌÑ∞ ÏòµÏÖò
        DrawFilterOptions();

        EditorGUILayout.Space(10);

        // Î™¨Ïä§ÌÑ∞ Î¶¨Ïä§Ìä∏
        DrawMonsterList();

        EditorGUILayout.Space(10);

        // ÌïòÎã® Î≤ÑÌäº
        DrawBottomButtons();
    }

    private void DrawSearchBar()
    {
        using (new EditorGUILayout.HorizontalScope())
        {
            EditorGUILayout.LabelField("Search:", GUILayout.Width(50));
            searchString = EditorGUILayout.TextField(searchString);

            if (GUILayout.Button("Clear", GUILayout.Width(50)))
            {
                searchString = "";
                GUI.FocusControl(null);
            }
        }
    }

    private void DrawFilterOptions()
    {
        using (new EditorGUILayout.HorizontalScope())
        {
            showAllTypes = EditorGUILayout.Toggle("Show All Types", showAllTypes, GUILayout.Width(150));

            if (!showAllTypes)
            {
                selectedType = (BattleCharacterSystem.MonsterType)EditorGUILayout.EnumPopup(selectedType);
            }
        }
    }

    private void DrawMonsterList()
    {
        using (var scrollView = new EditorGUILayout.ScrollViewScope(scrollPos, EditorStyles.helpBox))
        {
            scrollPos = scrollView.scrollPosition;

            // None ÏòµÏÖò (Ïä¨Î°Ø ÎπÑÏö∞Í∏∞)
            GUI.backgroundColor = Color.gray;
            if (GUILayout.Button("[Clear Slot]", GUILayout.Height(25)))
            {
                onMonsterSelected?.Invoke(0, targetSlotIndex);
                Close();
            }
            GUI.backgroundColor = Color.white;

            EditorGUILayout.Space(5);

            // ÏàòÏ†ïÎêú Î∂ÄÎ∂Ñ: ÌÉÄÏûÖ ÌÜµÏùº
            IEnumerable<BattleCharacterSystem.MonsterType> typesToShow;
            if (showAllTypes)
            {
                typesToShow = monstersByType.Keys.OrderBy(t => t);
            }
            else
            {
                typesToShow = new[] { selectedType };
            }

            foreach (var type in typesToShow)
            {
                if (!monstersByType.ContainsKey(type)) continue;

                var monsters = monstersByType[type];
                var filteredMonsters = FilterMonsters(monsters);

                if (filteredMonsters.Count == 0) continue;

                // ÌÉÄÏûÖ Ìó§Îçî (Foldout)
                int typeIndex = (int)type;
                using (new EditorGUILayout.HorizontalScope())
                {
                    typeFoldouts[typeIndex] = EditorGUILayout.Foldout(
                        typeFoldouts[typeIndex],
                        $"{GetMonsterTypeIcon(type)} {type} ({filteredMonsters.Count})",
                        true
                    );
                }

                if (typeFoldouts[typeIndex])
                {
                    EditorGUI.indentLevel++;

                    foreach (var monster in filteredMonsters)
                    {
                        DrawMonsterEntry(monster);
                    }

                    EditorGUI.indentLevel--;
                }

                EditorGUILayout.Space(5);
            }
        }
    }

    private void DrawMonsterEntry(BattleMonsterDataSO monster)
    {
        using (new EditorGUILayout.HorizontalScope())
        {
            // Î™¨Ïä§ÌÑ∞ Ï†ïÎ≥¥
            string label = $"[{monster.MonsterId}] {monster.MonsterName}";

            // Î≥¥Ïä§ ÌëúÏãú
            if (monster.IsBoss)
            {
                GUI.color = Color.yellow;
                label += " [BOSS]";
            }

            // ÏõêÏÜå ÌÉÄÏûÖ ÌëúÏãú
            label += $" ({monster.ElementType})";

            if (GUILayout.Button(label, EditorStyles.label))
            {
                SelectMonster(monster);
            }

            GUI.color = Color.white;

            GUILayout.FlexibleSpace();

            // ÏÑ†ÌÉù Î≤ÑÌäº
            if (GUILayout.Button("Select", GUILayout.Width(60)))
            {
                SelectMonster(monster);
            }
        }
    }

    private List<BattleMonsterDataSO> FilterMonsters(List<BattleMonsterDataSO> monsters)
    {
        if (string.IsNullOrEmpty(searchString))
            return monsters;

        string search = searchString.ToLower();
        return monsters.Where(m =>
            m.MonsterName.ToLower().Contains(search) ||
            m.MonsterId.ToString().Contains(search) ||
            m.ElementType.ToString().ToLower().Contains(search)
        ).ToList();
    }

    private void SelectMonster(BattleMonsterDataSO monster)
    {
        onMonsterSelected?.Invoke(monster.MonsterId, targetSlotIndex);
        Close();
    }

    private void DrawBottomButtons()
    {
        using (new EditorGUILayout.HorizontalScope())
        {
            GUILayout.FlexibleSpace();

            if (GUILayout.Button("Cancel", GUILayout.Width(100)))
            {
                Close();
            }
        }
    }

    private string GetMonsterTypeIcon(BattleCharacterSystem.MonsterType type)
    {
        switch (type)
        {
            case BattleCharacterSystem.MonsterType.Normal: return "üëæ";
            case BattleCharacterSystem.MonsterType.Elite: return "üëπ";
            case BattleCharacterSystem.MonsterType.MiniBoss: return "ü¶æ";
            case BattleCharacterSystem.MonsterType.Boss: return "üë∫";
            case BattleCharacterSystem.MonsterType.Special: return "‚ú®";
            default: return "‚ùì";
        }
    }
}
